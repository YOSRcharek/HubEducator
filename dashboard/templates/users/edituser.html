{% extends 'baseB.html' %} 
{% load static %}

{% block title %}Edit User{% endblock %}

{% block content %}
  <div class="col-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Edit User</h4>
      
      <form class="form-inline" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Username -->
        <label class="sr-only" for="inlineFormInputUsername">Username</label>
        <input type="text" class="form-control mb-2 mr-sm-2" 
               id="inlineFormInputUsername" 
               name="username" 
               value="{{ form.instance.username }}" 
               placeholder="Jane Doe">
        {% if form.username.errors %}
          <div class="text-danger small">{{ form.username.errors.0 }}</div>
        {% endif %}

        <!-- Email -->
        <label class="sr-only" for="inlineFormInputEmail">Email</label>
        <div class="input-group mb-2 mr-sm-2">
          <div class="input-group-prepend">
            <div class="input-group-text">@</div>
          </div>
          <input type="email" class="form-control" 
                 id="inlineFormInputEmail" 
                 name="email" 
                 value="{{ form.instance.email }}" 
                 placeholder="Email">
        </div>
        {% if form.email.errors %}
          <div class="text-danger small">{{ form.email.errors.0 }}</div>
        {% endif %}

        <!-- Role -->
        <label class="sr-only" for="inlineFormSelectRole">Role</label>
        <select class="form-control mb-2 mr-sm-2" id="inlineFormSelectRole" name="role" required>
          <option value="">Choose role...</option>
          <option value="student" {% if form.instance.role == "student" %}selected{% endif %}>Student</option>
          <option value="teacher" {% if form.instance.role == "teacher" %}selected{% endif %}>Teacher</option>
        </select>
        {% if form.role.errors %}
          <div class="text-danger small">{{ form.role.errors.0 }}</div>
        {% endif %}

        <!-- Picture -->
        <label class="sr-only" for="pictureInput">Picture</label>
        <div class="input-group mb-2 mr-sm-2">
          <input type="file" id="pictureInput" name="profile_picture" accept="image/*" style="display: none;" onchange="previewFile(event)" />
          <button type="button" class="btn btn-outline-primary btn-icon-text" onclick="document.getElementById('pictureInput').click();">
            <i class="mdi mdi-upload btn-icon-prepend"></i>
            Upload
          </button>
          <span id="fileName" class="ms-2"></span>
        </div>

        <!-- Show current picture -->
        {% if form.instance.profile_picture %}
          <div class="mt-2">
            <p>Current Picture:</p>
            <img src="{{ form.instance.profile_picture.url }}" 
                 alt="Current Profile Picture" 
                 style="max-width: 120px; border-radius:8px;">
          </div>
        {% endif %}

        <!-- Preview new picture -->
        <div class="mt-2">
          <img id="previewImg" src="" alt="Preview" style="max-width: 120px; display:none; border-radius:8px;" />
        </div>
        {% if form.profile_picture.errors %}
          <div class="text-danger small">{{ form.profile_picture.errors.0 }}</div>
        {% endif %}

        <!-- Buttons -->
        <div class="mt-3 d-flex justify-content-between">
          <a href="{% url 'users' %}" class="btn btn-outline-primary btn-fw">Return</a>
          <button type="submit" class="btn btn-primary">Update</button>
        </div>
      </form>

      <script>
        function previewFile(event) {
          const input = event.target;
          const file = input.files[0];
          if (file) {
            document.getElementById("fileName").innerText = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.getElementById("previewImg");
              preview.src = e.target.result;
              preview.style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        }
      </script>

    </div>
  </div>
</div>
{% endblock %}
